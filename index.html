<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Skincare Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        :root {
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f1f5f9; /* slate-100 */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-primary: #ec4899; /* pink-500 */
            --accent-secondary: #38bdf8; /* sky-500 */
            --danger-primary: #ef4444; /* red-500 */
            --warning-primary: #f97316; /* orange-500 */
        }
        html.dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .view { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-button {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            color: var(--text-secondary);
        }
        .nav-button:hover { background-color: var(--bg-tertiary); }
        .nav-button.active {
            background-color: var(--accent-primary);
            color: white !important;
        }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu { display: none; position: absolute; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* For Toggle Switches */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--accent-primary);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--accent-primary);
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">

        <!-- Header and Navigation -->
        <header class="bg-secondary/80 backdrop-blur-lg sticky top-4 z-50 rounded-xl shadow-md border border-border-color">
            <nav class="flex items-center justify-between p-3">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="switchView('home')">
                    <svg class="h-8 w-8 text-accent-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624l.259 1.035L18 21.75l-.843-2.846a4.5 4.5 0 00-3.09-3.09L11.25 15l2.846-.813a4.5 4.5 0 003.09-3.09l.813-2.846L18 9.75l-.259 1.035a3.375 3.375 0 00-2.455 2.456L14.25 14.25l1.036.259a3.375 3.375 0 002.455 2.456z" />
                    </svg>
                    <h1 class="text-xl md:text-2xl font-bold text-primary">Skincare Hub</h1>
                </div>
                <!-- Desktop Nav -->
                <div class="hidden lg:flex items-center space-x-1">
                    <button onclick="switchView('home')" class="nav-button" id="nav-home">Home</button>
                    <!-- My Hub Dropdown -->
                    <div class="relative dropdown">
                        <button class="nav-button" id="nav-hub">My Hub</button>
                        <div class="dropdown-menu mt-2 w-48 bg-secondary rounded-md shadow-lg border border-border-color py-1">
                             <a href="#" onclick="switchView('shelf')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">My Shelf</a>
                             <a href="#" onclick="switchView('calendar')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Calendar</a>
                             <a href="#" onclick="switchView('journal')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Journal</a>
                        </div>
                    </div>
                    <!-- Core Tools Dropdown -->
                    <div class="relative dropdown">
                        <button class="nav-button" id="nav-core">Core Tools</button>
                        <div class="dropdown-menu mt-2 w-48 bg-secondary rounded-md shadow-lg border border-border-color py-1">
                             <a href="#" onclick="switchView('generator')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Routine Generator</a>
                             <a href="#" onclick="switchView('analyzer')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Routine Analyzer</a>
                        </div>
                    </div>
                    <!-- Discovery Dropdown -->
                    <div class="relative dropdown">
                        <button class="nav-button" id="nav-discovery">Discovery</button>
                         <div class="dropdown-menu mt-2 w-48 bg-secondary rounded-md shadow-lg border border-border-color py-1">
                             <a href="#" onclick="switchView('ingredients')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Ingredient Dex</a>
                             <a href="#" onclick="switchView('dupes')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Dupe Finder</a>
                             <a href="#" onclick="switchView('combo')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Combo Checker</a>
                             <a href="#" onclick="switchView('decoder')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">INCI Decoder</a>
                        </div>
                    </div>
                    <!-- Learn Dropdown -->
                     <div class="relative dropdown">
                        <button class="nav-button" id="nav-learn">Learn</button>
                         <div class="dropdown-menu mt-2 w-48 bg-secondary rounded-md shadow-lg border border-border-color py-1">
                            <a href="#" onclick="switchView('guides')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Guides</a>
                            <a href="#" onclick="switchView('glossary')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Glossary</a>
                            <a href="#" onclick="switchView('quiz')" class="block px-4 py-2 text-sm text-secondary hover:bg-tertiary">Skincare Quiz</a>
                         </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Settings Button -->
                    <button onclick="switchView('settings')" class="p-2 rounded-full hover:bg-tertiary" aria-label="Settings">
                         <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8.21 5.15c-.5.42-1.12.7-1.78.83l-2.05.32c-1.68.27-2.39 2.28-1.15 3.53l1.48 1.44c.36.35.52.86.44 1.37l-.32 2.05c-.27 1.68 1.45 3.03 3.03 2.45l2.05-.32c.5-.08 1.02.08 1.37.44l1.44 1.48c1.25 1.25 3.26.54 3.53-1.15l.32-2.05c.08-.5.42-1.02.83-1.44l1.83-1.48c1.25-1.25.54-3.26-1.15-3.53l-2.05-.32a2.6 2.6 0 0 1-1.78-.83l-1.48-1.83zM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" clip-rule="evenodd"></path></svg>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-tertiary" aria-label="Toggle Dark Mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 016.465 3.636l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM5 11a1 1 0 100-2H4a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <!-- Mobile Nav -->
                    <div class="lg:hidden">
                         <select onchange="switchView(this.value)" class="nav-button bg-secondary border border-border-color rounded-md p-2">
                             <option value="home">Home</option>
                             <optgroup label="My Hub">
                                 <option value="shelf">My Shelf</option>
                                 <option value="calendar">Calendar</option>
                                 <option value="journal">Journal</option>
                             </optgroup>
                             <optgroup label="Core Tools">
                                <option value="generator">Generator</option>
                                <option value="analyzer">Analyzer</option>
                             </optgroup>
                             <optgroup label="Discovery">
                                <option value="ingredients">Ingredient Dex</option>
                                <option value="dupes">Dupe Finder</option>
                                <option value="combo">Combo Checker</option>
                                <option value="decoder">INCI Decoder</option>
                             </optgroup>
                             <optgroup label="Learn">
                                 <option value="guides">Guides</option>
                                 <option value="glossary">Glossary</option>
                                 <option value="quiz">Quiz</option>
                             </optgroup>
                             <option value="settings">Settings</option>
                         </select>
                    </div>
                </div>
            </nav>
        </header>

        <main class="mt-8">
            <!-- All views will be injected here by the router -->
            <div id="home-view" class="view"></div>
            <div id="shelf-view" class="view"></div>
            <div id="calendar-view" class="view"></div>
            <div id="journal-view" class="view"></div>
            <div id="generator-view" class="view"></div>
            <div id="analyzer-view" class="view"></div>
            <div id="ingredients-view" class="view"></div>
            <div id="dupes-view" class="view"></div>
            <div id="combo-view" class="view"></div>
            <div id="decoder-view" class="view"></div>
            <div id="guides-view" class="view"></div>
            <div id="glossary-view" class="view"></div>
            <div id="quiz-view" class="view"></div>
            <div id="settings-view" class="view"></div>
        </main>
        
        <!-- Modal for alerts and confirmations -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
            <div id="modal-content" class="bg-secondary p-6 rounded-lg shadow-xl max-w-lg w-full max-h-full overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h3 id="modal-title" class="text-lg font-bold text-primary"></h3>
                    <button onclick="closeModal()" class="text-secondary hover:text-primary">&times;</button>
                </div>
                <div id="modal-body" class="text-sm text-secondary mt-2"></div>
                <div id="modal-actions" class="mt-4 flex justify-end space-x-2"></div>
            </div>
        </div>
    </div>
<script>
// --- DATABASE (Self-contained, no external calls) ---
const ingredientsDB = {
    // Solvents, Humectants, Emollients
    'water': { name: 'Water (Aqua)', cat: 'Base', good: ['All'], safety: {}, desc: 'The base for most skincare products. Used as a solvent to dissolve other ingredients.' },
    'glycerin': { name: 'Glycerin', cat: 'Humectant', good: ['All', 'Dry', 'Dehydrated'], safety: {}, desc: 'A powerful humectant that draws moisture from the air into the skin. Excellent for hydration.' },
    'hyaluronic acid': { name: 'Hyaluronic Acid', cat: 'Humectant', good: ['All', 'Dry', 'Dehydrated'], safety: {}, desc: 'Can hold up to 1000x its weight in water, providing intense hydration.' },
    'squalane': { name: 'Squalane', cat: 'Emollient', good: ['All'], safety: {}, desc: 'A lightweight, non-comedogenic oil that mimics the skin\'s natural sebum, providing moisture without feeling heavy.' },
    'shea butter': { name: 'Shea Butter', cat: 'Emollient', good: ['Dry'], safety: {}, desc: 'A rich plant butter that deeply moisturizes and nourishes the skin. Can be heavy for oily types.' },
    'dimethicone': { name: 'Dimethicone', cat: 'Occlusive', good: ['All'], safety: {}, desc: 'A silicone that forms a protective barrier on the skin, locking in moisture and giving a smooth, silky feel.' },
    // Actives & Exfoliants
    'niacinamide': { name: 'Niacinamide (B3)', cat: 'Active', good: ['All', 'Oily', 'Acne', 'Redness'], safety: {}, desc: 'A versatile ingredient that helps with oil control, redness, pore appearance, and barrier function.' },
    'salicylic acid': { name: 'Salicylic Acid (BHA)', cat: 'Exfoliant', good: ['Oily', 'Acne'], safety: {pregnancy: 'consult', accutane: 'avoid'}, desc: 'A beta-hydroxy acid that exfoliates inside the pores, making it fantastic for treating acne and blackheads.' },
    'glycolic acid': { name: 'Glycolic Acid (AHA)', cat: 'Exfoliant', good: ['Normal', 'Pigmentation', 'Aging'], safety: {pregnancy: 'consult', accutane: 'avoid'}, desc: 'An alpha-hydroxy acid that exfoliates the surface of the skin to improve texture and brightness.' },
    'lactic acid': { name: 'Lactic Acid (AHA)', cat: 'Exfoliant', good: ['Dry', 'Sensitive', 'Pigmentation'], safety: {}, desc: 'A gentler AHA that exfoliates and hydrates simultaneously.' },
    'retinol': { name: 'Retinol (Vitamin A)', cat: 'Active', good: ['Aging', 'Acne'], safety: {pregnancy: 'avoid', accutane: 'avoid'}, desc: 'A form of Vitamin A that speeds up cell turnover. A gold-standard ingredient for anti-aging and acne.' },
    'bakuchiol': { name: 'Bakuchiol', cat: 'Active', good: ['Aging', 'Sensitive'], safety: {}, desc: 'A plant-based alternative to retinol with similar anti-aging benefits but less irritation potential.' },
    'l-ascorbic acid': { name: 'L-Ascorbic Acid (Vit C)', cat: 'Antioxidant', good: ['All', 'Pigmentation', 'Aging', 'Dullness'], safety: {accutane: 'caution'}, desc: 'A potent antioxidant that can be irritating for compromised skin. Use with caution.' },
    // Soothing & Barrier Support
    'ceramide np': { name: 'Ceramide NP', cat: 'Barrier', good: ['All', 'Dry', 'Sensitive'], safety: {}, desc: 'Lipids that are a fundamental part of the skin barrier. They help retain moisture and protect the skin.' },
    'centella asiatica extract': { name: 'Centella Asiatica (Cica)', cat: 'Soothing', good: ['Sensitive', 'Redness', 'Acne'], safety: {}, desc: 'A plant extract known for its soothing, anti-inflammatory, and wound-healing properties.' },
    'panthenol': { name: 'Panthenol (B5)', cat: 'Humectant', good: ['All', 'Dry', 'Sensitive'], safety: {}, desc: 'A humectant with soothing and barrier-supporting properties.' },
    // UV Filters
    'zinc oxide': { name: 'Zinc Oxide', cat: 'UV Filter', good: ['All', 'Sensitive'], safety: {}, desc: 'A mineral (physical) sunscreen filter that provides broad-spectrum protection.' },
    'avobenzone': { name: 'Avobenzone', cat: 'UV Filter', good: ['All'], safety: {}, desc: 'A chemical sunscreen filter that provides excellent UVA protection.' },
    // Potentially Problematic
    'fragrance': { name: 'Fragrance (Parfum)', cat: 'Sensitizer', good: [], safety: { accutane: 'caution' }, desc: 'A common cause of skin sensitivity and allergic reactions. Can be listed as "Parfum".' },
    'alcohol denat': { name: 'Denatured Alcohol', cat: 'Solvent', good: ['Very Oily'], safety: {accutane: 'caution'}, desc: 'Can be very drying and irritating for many skin types, especially when high on the INCI list.' },
    'coconut oil': { name: 'Coconut Oil', cat: 'Emollient', good: ['Very Dry Body Skin'], safety: {}, desc: 'A very moisturizing oil, but highly comedogenic and not recommended for the face for most people.' },
};

const productsDB = [
    { id: 'p01', name: "CeraVe Hydrating Cleanser", brand: "CeraVe", price: 15, type: 'cleanser', key_ing: ['ceramide np', 'hyaluronic acid'], all_ing: "water, glycerin, cetearyl alcohol, peg-40 stearate, stearyl alcohol, potassium phosphate, ceramide np, ceramide ap, ceramide eop, carbomer, glyceryl stearate, behentrimonium methosulfate, sodium lauroyl lactylate, sodium hyaluronate, cholesterol, phenoxyethanol, disodium edta, dipotassium phosphate, tocopherol, phytosphingosine, xanthan gum, cetyl alcohol, polysorbate 20, ethylhexylglycerin" },
    { id: 'p02', name: "La Roche-Posay Toleriane Purifying Foaming Cleanser", brand: "La Roche-Posay", price: 16, type: 'cleanser', key_ing: ['ceramide np', 'niacinamide'], all_ing: "water, glycerin, coco-betaine, propanediol, sodium cocoyl glycinate, peg-120 methyl glucose dioleate, sodium chloride, ceramide np, niacinamide, sodium hydroxide, disodium edta, capryloyl glycine, caprylyl glycol, acrylates copolymer" },
    { id: 'p03', name: "The Ordinary Niacinamide 10% + Zinc 1%", brand: "The Ordinary", price: 6, type: 'serum', key_ing: ['niacinamide'], all_ing: "water, niacinamide, pentylene glycol, zinc pca, dimethicone, tamarindus indica seed gum, xanthan gum, isoceteth-20, ethoxydiglycol, phenoxyethanol, chlorphenesin" },
    { id: 'p04', name: "Paula's Choice 2% BHA Liquid Exfoliant", brand: "Paula's Choice", price: 32, type: 'exfoliant', key_ing: ['salicylic acid'], all_ing: "water, methylpropanediol, butylene glycol, salicylic acid, polysorbate 20, camellia oleifera (green tea) leaf extract, sodium hydroxide, tetrasodium edta" },
    { id: 'p05', name: "SkinCeuticals C E Ferulic", brand: "SkinCeuticals", price: 169, type: 'serum', key_ing: ['l-ascorbic acid', 'tocopherol', 'ferulic acid'], all_ing: "water, ethoxydiglycol, l-ascorbic acid, glycerin, propylene glycol, laureth-23, phenoxyethanol, tocopherol, triethanolamine, ferulic acid, panthenol, sodium hyaluronate" },
    { id: 'p06', name: "Drunk Elephant Protini Polypeptide Cream", brand: "Drunk Elephant", price: 68, type: 'moisturizer', key_ing: ['peptides', 'lactic acid'], all_ing: "water, dicaprylyl carbonate, glycerin, cetearyl alcohol, cetearyl olivate, sorbitan olivate, sh-oligopeptide-1, sh-oligopeptide-2, sh-polypeptide-1, sh-polypeptide-9, sh-polypeptide-11, copper palmitoyl heptapeptide-14, heptapeptide-15 palmitate, palmitoyl tetrapeptide-7, palmitoyl tripeptide-1, n-prolyl palmitoyl tripeptide-56 acetate, lactic acid, alanine, arginine, glycine, histidine, isoleucine, phenylalanine, proline, serine, threonine, valine, aspartic acid, sodium lactate, sodium pca, pca, sorbitan isostearate, carbomer, polysorbate 20, polysorbate 60, caprylyl glycol, phenoxyethanol, chlorphenesin, potassium sorbate, sodium benzoate" },
    { id: 'p07', name: "The INKEY List Retinol Serum", brand: "The INKEY List", price: 11, type: 'serum', key_ing: ['retinol', 'squalane'], all_ing: "water, glycerin, butylene glycol, propanediol, dicaprylyl carbonate, dimethicone, retinol, hydroxyethyl acrylate/sodium acryloyldimethyl taurate copolymer, caprylyl glycol, phospholipids, caprylic/capric glycerides, squalane, sodium hyaluronate, polysorbate 60, phenoxyethanol, leuconostoc/radish root ferment filtrate, sorbitan isostearate" },
    { id: 'p08', name: "Supergoop! Unseen Sunscreen SPF 40", brand: "Supergoop!", price: 36, type: 'sunscreen', key_ing: ['avobenzone', 'shea butter'], all_ing: "avobenzone, 3%, homosalate, 8%, octisalate, 5%, octocrylene, 4%, isododecane, dimethicone crosspolymer, dimethicone/bis-isobutyl ppg-20 crosspolymer, polymethylsilsesquioxane, isohexadecane, dicaprylyl carbonate, meadowfoam estolide, caprylic/capric triglyceride, trimethylsiloxysilicate, caprylyl glycol, silica, tocopherol, shea butter" },
];

// ... rest of DBs (glossaryDB, quizDB, ingredientConflicts) would be here, truncated for brevity ...
const glossaryDB = {
    'Double Cleansing': 'A two-step cleansing method. First, an oil-based cleanser removes makeup and SPF. Second, a water-based cleanser cleans the skin itself. Ideal for PM routines.',
    'Comedogenic': 'Refers to ingredients or products that have a tendency to clog pores, which can lead to blackheads and acne. Ratings are a guide, not a rule.',
    'Slugging': 'The practice of applying an occlusive layer (like Vaseline or Aquaphor) as the final step of a nighttime routine to prevent water loss and boost barrier function.'
};

const quizDB = [
    { 
        q: "What is the single most important product for anti-aging?", 
        o: ["Retinol Serum", "Vitamin C Serum", "Broad-Spectrum Sunscreen", "Hyaluronic Acid"], 
        a: 2,
        exp: "Sunscreen is non-negotiable. Up to 90% of visible aging is caused by sun exposure. While other products help, preventing the damage in the first place is most effective."
    },
    { 
        q: "You should NOT mix Retinol with which of these in the same application?", 
        o: ["Niacinamide", "Hyaluronic Acid", "AHA/BHA Acids", "Ceramides"], 
        a: 2,
        exp: "Combining strong actives like Retinol and exfoliating acids (AHAs/BHAs) in the same routine can lead to over-exfoliation, irritation, and a compromised skin barrier."
    },
    {
        q: "The 'P.A.' rating on Asian sunscreens (e.g., PA++++) refers to protection against:",
        o: ["UVB (Burning rays)", "UVA (Aging rays)", "Blue Light", "Infrared Radiation"],
        a: 1,
        exp: "SPF measures protection against UVB rays, which cause sunburn. The PA rating system measures protection against UVA rays, which are responsible for photo-aging."
    }
];

const ingredientConflicts = {
    'retinol': ['glycolic acid', 'salicylic acid', 'l-ascorbic acid'],
    'glycolic acid': ['retinol', 'salicylic acid'],
    'salicylic acid': ['retinol', 'glycolic acid'],
    'l-ascorbic acid': ['retinol']
};

// --- APPLICATION STATE & LOGIC ---

let appState = {
    currentView: 'home',
    userData: {
        settings: {
            darkMode: false,
            pregnancySafe: false,
            accutaneSafe: false,
            forbiddenIngredients: [],
        },
        myShelf: [], // {productId: 'p01', status: 'owned'/'wishlist'/'empties', dateAdded: '...'}
        journal: [],
        calendar: {} // { '2024-06-09': { am: [p_id], pm: [p_id] } }
    },
    productsFuse: null,
    ingredientsFuse: null,
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', init);

function init() {
    // Load data from localStorage
    const savedData = localStorage.getItem('skincareHubData_v2');
    if (savedData) {
        // A simple merge to prevent losing data on updates
        const parsedData = JSON.parse(savedData);
        if (parsedData.settings) { // Check if settings exist before merging
             Object.assign(appState.userData.settings, parsedData.settings);
        }
        appState.userData.myShelf = parsedData.myShelf || [];
        appState.userData.journal = parsedData.journal || [];
        appState.userData.calendar = parsedData.calendar || [];

    } else {
        saveData();
    }
    
    // Setup search
    appState.productsFuse = new Fuse(productsDB, { keys: ['name', 'brand'] });
    appState.ingredientsFuse = new Fuse(Object.values(ingredientsDB), { keys: ['name', 'cat', 'desc'] });

    // Setup UI based on saved settings
    if (appState.userData.settings.darkMode) {
        document.documentElement.classList.add('dark');
    }
    updateThemeIcons();
    switchView('home');
}

// --- DATA PERSISTENCE ---
function saveData() {
    try {
        localStorage.setItem('skincareHubData_v2', JSON.stringify(appState.userData));
    } catch (e) {
        console.error("Failed to save data to localStorage", e);
        showAlert("Save Error", "Could not save your data. Your browser's storage might be full.");
    }
}

// --- VIEW ROUTING & RENDERING ---
function switchView(viewId) {
    if(!viewId) return;
    const views = document.querySelectorAll('.view');
    views.forEach(v => v.style.display = 'none');
    
    const targetView = document.getElementById(`${viewId}-view`);
    if (targetView) {
        targetView.innerHTML = `<div class="text-center p-8 text-secondary">Loading ${viewId}...</div>`;
        targetView.style.display = 'block';
        appState.currentView = viewId;
        
        // Use a tiny timeout to allow the browser to render the "Loading..." message before starting a potentially long render
        setTimeout(() => renderCurrentView(viewId), 10);
    }

    // Update nav button states
    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(`nav-${viewId}`) || document.querySelector(`#nav-${getNavGroup(viewId)}`);
    if (activeBtn) activeBtn.classList.add('active');
}

function getNavGroup(viewId) {
    if (['shelf', 'calendar', 'journal'].includes(viewId)) return 'hub';
    if (['generator', 'analyzer'].includes(viewId)) return 'core';
    if (['ingredients', 'dupes', 'combo', 'decoder'].includes(viewId)) return 'discovery';
    if (['guides', 'glossary', 'quiz'].includes(viewId)) return 'learn';
    return viewId;
}

function renderCurrentView(viewId) {
    const container = document.getElementById(`${viewId}-view`);
    if (!container) return;

    let renderer = window[`render${viewId.charAt(0).toUpperCase() + viewId.slice(1)}View`];
    if (typeof renderer === 'function') {
        container.innerHTML = renderer();
    } else {
        container.innerHTML = `<div class="text-center p-8 text-danger-primary">Error: View "${viewId}" not found.</div>`;
    }
    
    // Post-render actions like attaching event listeners
    let setupFunction = window[`setup${viewId.charAt(0).toUpperCase() + viewId.slice(1)}Listeners`];
    if (typeof setupFunction === 'function') {
        setupFunction();
    }
}

// --- UI & THEME ---
function toggleDarkMode() {
    appState.userData.settings.darkMode = !appState.userData.settings.darkMode;
    document.documentElement.classList.toggle('dark');
    updateThemeIcons();
    saveData();
}

function updateThemeIcons() {
    if (document.documentElement.classList.contains('dark')) {
        document.getElementById('theme-toggle-dark-icon').style.display = 'block';
        document.getElementById('theme-toggle-light-icon').style.display = 'none';
    } else {
        document.getElementById('theme-toggle-dark-icon').style.display = 'none';
        document.getElementById('theme-toggle-light-icon').style.display = 'block';
    }
}

// --- MODAL/ALERT SYSTEM ---
function showAlert(title, body, actions = [{ text: 'OK', class: 'bg-accent-primary text-white', action: closeModal }]) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-body').innerHTML = body; // Use innerHTML to allow for formatted content
    const actionsContainer = document.getElementById('modal-actions');
    actionsContainer.innerHTML = '';
    actions.forEach(act => {
        const btn = document.createElement('button');
        btn.innerText = act.text;
        btn.className = `px-4 py-2 rounded-md font-semibold ${act.class}`;
        btn.onclick = act.action;
        actionsContainer.appendChild(btn);
    });
    document.getElementById('modal-container').style.display = 'flex';
}

function closeModal() {
    document.getElementById('modal-container').style.display = 'none';
}


// --- DYNAMIC VIEW RENDERER FUNCTIONS ---
// Each function is responsible for rendering the HTML for a single view.
// This is more organized than a giant if/else block.

function renderHomeView() {
    return `
        <div class="text-center p-8 bg-secondary rounded-xl border border-border-color shadow-sm">
            <h2 class="text-3xl md:text-4xl font-bold text-primary mb-4">The Ultimate Skincare Hub</h2>
            <p class="max-w-3xl mx-auto text-secondary mb-8">
                Welcome back! All your data is stored privately in your browser. From your personal product shelf to a weekly routine calendar, all the tools you need are right here.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div onclick="switchView('shelf')" class="p-6 bg-tertiary hover:bg-border-color rounded-lg cursor-pointer transition-colors border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-2">My Digital Shelf</h3>
                    <p class="text-sm text-secondary">Manage your owned products, create a wishlist, and track empties.</p>
                </div>
                <div onclick="switchView('analyzer')" class="p-6 bg-tertiary hover:bg-border-color rounded-lg cursor-pointer transition-colors border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-2">Routine Analyzer</h3>
                    <p class="text-sm text-secondary">Get an expert analysis of your AM/PM routine for conflicts and insights.</p>
                </div>
                <div onclick="switchView('calendar')" class="p-6 bg-tertiary hover:bg-border-color rounded-lg cursor-pointer transition-colors border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-2">Routine Calendar</h3>
                    <p class="text-sm text-secondary">Visually plan your use of actives to keep your skin happy and healthy.</p>
                </div>
                <div onclick="switchView('dupes')" class="p-6 bg-tertiary hover:bg-border-color rounded-lg cursor-pointer transition-colors border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-2">Dupe Finder</h3>
                    <p class="text-sm text-secondary">Find affordable alternatives for popular products based on key ingredients.</p>
                </div>
                 <div onclick="switchView('decoder')" class="p-6 bg-tertiary hover:bg-border-color rounded-lg cursor-pointer transition-colors border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-2">INCI Decoder</h3>
                    <p class="text-sm text-secondary">Paste an ingredient list to get a full breakdown of what's inside.</p>
                </div>
                 <div onclick="switchView('quiz')" class="p-6 bg-tertiary hover:bg-border-color rounded-lg cursor-pointer transition-colors border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-2">Test Your Knowledge</h3>
                    <p class="text-sm text-secondary">Take our skincare quiz to bust common myths and learn new facts.</p>
                </div>
            </div>
        </div>
    `;
}

function renderSettingsView() {
     const forbiddenIngredientsText = appState.userData.settings.forbiddenIngredients.join(', ');
     return `
        <h2 class="text-3xl font-bold text-center mb-6">Settings</h2>
        <div class="max-w-2xl mx-auto bg-secondary p-6 rounded-xl shadow-md border border-border-color space-y-6">
            
            <div>
                <h3 class="text-lg font-semibold text-primary">Safety Filters</h3>
                <p class="text-sm text-secondary mb-4">When enabled, the app will flag ingredients that are typically avoided under these conditions.</p>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label for="pregnancy-safe-toggle" class="font-medium text-primary">Pregnancy/Nursing Safe Mode</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" onchange="updateSetting('pregnancySafe', this.checked)" name="pregnancy-safe-toggle" id="pregnancy-safe-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${appState.userData.settings.pregnancySafe ? 'checked' : ''}/>
                            <label for="pregnancy-safe-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                     <div class="flex items-center justify-between">
                        <label for="accutane-safe-toggle" class="font-medium text-primary">Accutane (Isotretinoin) Safe Mode</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" onchange="updateSetting('accutaneSafe', this.checked)" name="accutane-safe-toggle" id="accutane-safe-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${appState.userData.settings.accutaneSafe ? 'checked' : ''}/>
                            <label for="accutane-safe-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-border-color"></div>

            <div>
                <h3 class="text-lg font-semibold text-primary">My Forbidden Ingredients</h3>
                <p class="text-sm text-secondary mb-2">List ingredients you are allergic to or that you know irritate your skin. Separate them with commas.</p>
                <textarea id="forbidden-ingredients-input" class="w-full p-2 bg-tertiary border border-border-color rounded-md" rows="3" placeholder="e.g., fragrance, lavender oil, alcohol denat">${forbiddenIngredientsText}</textarea>
                <button onclick="updateForbiddenIngredients()" class="mt-2 px-4 py-2 bg-accent-primary text-white font-semibold rounded-lg hover:bg-opacity-90">Save Forbidden List</button>
            </div>

            <div class="border-t border-border-color"></div>

            <div>
                 <h3 class="text-lg font-semibold text-primary">Data Management</h3>
                 <p class="text-sm text-secondary mb-2">All your data is stored on this device. You can export it for backup or delete it.</p>
                 <div class="flex space-x-2">
                    <button onclick="exportData()" class="px-4 py-2 bg-accent-secondary text-white font-semibold rounded-lg hover:bg-opacity-90">Export Data</button>
                    <button onclick="confirmDeleteData()" class="px-4 py-2 bg-danger-primary text-white font-semibold rounded-lg hover:bg-opacity-90">Delete All My Data</button>
                 </div>
            </div>
        </div>
    `;
}

function renderDupesView() {
    let options = productsDB
        .sort((a, b) => b.price - a.price) // Show most expensive first
        .map(p => `<option value="${p.id}">${p.name} ($${p.price})</option>`).join('');

    return `
         <h2 class="text-3xl font-bold text-center mb-6">Product Dupe Finder</h2>
         <div class="max-w-2xl mx-auto bg-secondary p-6 rounded-xl shadow-md border border-border-color">
            <p class="text-secondary mb-4">Select a product (usually a pricier one) to find other products in our database that share one or more of its key active ingredients.</p>
            <select id="dupe-product-select" onchange="findDupes(this.value)" class="w-full p-2 border border-border-color rounded-md bg-tertiary">
                <option value="">-- Select a Product --</option>
                ${options}
            </select>
            <div id="dupe-results" class="mt-6">
                <p class="text-center text-secondary">Your dupe results will appear here.</p>
            </div>
         </div>
    `;
}

function renderQuizView() {
    let questionsHtml = quizDB.map((item, index) => `
        <div class="bg-tertiary p-4 rounded-lg border border-border-color">
            <p class="font-semibold text-primary">${index + 1}. ${item.q}</p>
            <div class="mt-2 space-y-2">
                ${item.o.map((option, optIndex) => `
                    <div>
                        <input type="radio" name="q${index}" id="q${index}o${optIndex}" value="${optIndex}" class="mr-2">
                        <label for="q${index}o${optIndex}" class="text-secondary">${option}</label>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');

    return `
        <h2 class="text-3xl font-bold text-center mb-6">Test Your Skincare Knowledge</h2>
        <div class="max-w-3xl mx-auto bg-secondary p-6 rounded-xl shadow-md border border-border-color">
            <div class="space-y-6">${questionsHtml}</div>
            <button onclick="submitQuiz()" class="w-full mt-6 px-4 py-3 bg-accent-primary text-white font-bold rounded-lg hover:bg-opacity-90">See My Score!</button>
            <div id="quiz-results" class="mt-6"></div>
        </div>
    `;
}

function renderDecoderView() {
    return `
        <h2 class="text-3xl font-bold text-center mb-6">INCI Decoder</h2>
        <div class="max-w-3xl mx-auto bg-secondary p-6 rounded-xl shadow-md border border-border-color">
            <p class="text-secondary mb-4">Paste a full INCI (ingredient) list from any product below. We'll break it down for you, highlighting key ingredients, potential irritants, and explaining what each one does.</p>
            <textarea id="inci-input" class="w-full p-2 bg-tertiary border border-border-color rounded-md" rows="6" placeholder="Water, Glycerin, Niacinamide, ..."></textarea>
            <button onclick="decodeInci()" class="w-full mt-4 px-4 py-3 bg-accent-primary text-white font-bold rounded-lg hover:bg-opacity-90">Decode Ingredient List</button>
            <div id="decoder-results" class="mt-6"></div>
        </div>
    `;
}

// Stubs for other views that are more complex and would be implemented next
function renderShelfView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">My Shelf feature is under construction.</div>`; }
function renderCalendarView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Calendar feature is under construction.</div>`; }
function renderJournalView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Journal feature is under construction.</div>`; }
function renderGeneratorView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Generator feature is under construction.</div>`; }
function renderAnalyzerView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Analyzer feature is under construction.</div>`; }
function renderIngredientsView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Ingredient Dex feature is under construction.</div>`; }
function renderComboView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Combo Checker feature is under construction.</div>`; }
function renderGuidesView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Guides feature is under construction.</div>`; }
function renderGlossaryView() { return `<div class="p-4 bg-secondary rounded-lg text-center text-secondary">Glossary feature is under construction.</div>`; }


// --- FEATURE LOGIC ---
function updateSetting(key, value) {
    if (appState.userData.settings.hasOwnProperty(key)) {
        appState.userData.settings[key] = value;
        saveData();
    }
}

function updateForbiddenIngredients() {
    const input = document.getElementById('forbidden-ingredients-input').value;
    appState.userData.settings.forbiddenIngredients = input.split(',')
        .map(s => s.trim().toLowerCase())
        .filter(s => s); // remove empty strings
    saveData();
    showAlert("Success!", "Your forbidden ingredients list has been saved.");
}

function findDupes(productId) {
    const resultsContainer = document.getElementById('dupe-results');
    if (!productId) {
        resultsContainer.innerHTML = '<p class="text-center text-secondary">Your dupe results will appear here.</p>';
        return;
    }
    const targetProduct = productsDB.find(p => p.id === productId);
    if (!targetProduct) {
        resultsContainer.innerHTML = '<p class="text-center text-danger-primary">Could not find the selected product.</p>';
        return;
    }

    const dupes = productsDB.filter(p => {
        if (p.id === targetProduct.id) return false;
        return p.key_ing.some(ing => targetProduct.key_ing.includes(ing));
    });

    if (dupes.length === 0) {
        resultsContainer.innerHTML = '<p class="text-center text-secondary">No potential dupes found in our database with similar key ingredients.</p>';
        return;
    }
    
    let html = `<h3 class="font-bold text-primary mb-2">Potential Alternatives for <span class="text-accent-primary">${targetProduct.name}</span></h3>`;
    html += dupes.map(dupe => {
        const sharedIng = dupe.key_ing.filter(ing => targetProduct.key_ing.includes(ing));
        return `
            <div class="p-4 bg-tertiary rounded-lg border border-border-color mb-3">
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold text-primary">${dupe.name}</h4>
                    <span class="font-bold text-lg ${dupe.price < targetProduct.price ? 'text-green-500' : 'text-danger-primary'}">$${dupe.price}</span>
                </div>
                <p class="text-xs text-secondary">${dupe.brand}</p>
                <p class="text-sm mt-2">Shared Key Ingredients: <span class="font-semibold">${sharedIng.join(', ')}</span></p>
            </div>
        `;
    }).join('');
    resultsContainer.innerHTML = html;
}

function submitQuiz() {
    let score = 0;
    quizDB.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        if (selected && parseInt(selected.value) === q.a) {
            score++;
        }
    });
    const resultsContainer = document.getElementById('quiz-results');
    resultsContainer.innerHTML = `
        <div class="p-4 bg-tertiary rounded-lg border border-border-color text-center">
            <h3 class="text-xl font-bold text-primary">You scored ${score} out of ${quizDB.length}!</h3>
            <div class="text-left mt-4 space-y-2">
                ${quizDB.map(q => `<p class="text-sm text-secondary"><strong>Answer:</strong> ${q.o[q.a]}<br><strong>Explanation:</strong> ${q.exp}</p>`).join('<hr class="my-2 border-border-color">')}
            </div>
        </div>
    `;
}

function decodeInci() {
    const inciList = document.getElementById('inci-input').value.split(',')
        .map(i => i.trim().toLowerCase().replace(/[^\w\s-]/g, ''))
        .filter(i => i);
    
    const resultsContainer = document.getElementById('decoder-results');
    if(inciList.length === 0) {
        resultsContainer.innerHTML = `<p class="text-secondary text-center">Please enter an ingredient list.</p>`;
        return;
    }

    let html = '<div class="space-y-2">';
    inciList.forEach(ingName => {
        const found = Object.entries(ingredientsDB).find(([key, val]) => ingName.includes(key));
        if (found) {
            const [key, ingData] = found;
            html += `
                <div class="p-3 bg-tertiary rounded-lg border border-border-color">
                    <h4 class="font-semibold text-primary">${ingData.name} <span class="text-xs font-normal text-accent-primary">${ingData.cat}</span></h4>
                    <p class="text-sm text-secondary">${ingData.desc}</p>
                </div>
            `;
        } else {
             html += `
                <div class="p-3 bg-tertiary rounded-lg border border-border-color opacity-60">
                    <h4 class="font-semibold text-primary">${ingName}</h4>
                    <p class="text-sm text-secondary">No information for this ingredient in our database.</p>
                </div>
            `;
        }
    });
    html += '</div>';
    resultsContainer.innerHTML = html;
}


function exportData() {
    const dataStr = JSON.stringify(appState.userData, null, 2);
    const dataBlob = new Blob([dataStr], {type : 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `skincare-hub-backup-${new Date().toISOString().slice(0,10)}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

function confirmDeleteData() {
    showAlert(
        "Are you sure?", 
        "This will permanently delete all your saved products, journal entries, and settings. This action cannot be undone.",
        [
            { text: 'Cancel', class: 'bg-tertiary text-primary', action: closeModal },
            { text: 'Yes, Delete Everything', class: 'bg-danger-primary text-white', action: () => {
                localStorage.removeItem('skincareHubData_v2');
                // Reset state to default
                appState.userData = { settings: { darkMode: document.documentElement.classList.contains('dark') }, myShelf: [], journal: [], calendar: {} };
                // Re-render the settings view to reflect the change
                switchView('settings');
                closeModal();
            }}
        ]
    );
}

</script>
</body>
</html>
